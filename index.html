<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音楽教育アプリ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <header class="mb-4">
            <h1 class="h3 text-center">音楽教育クイズ</h1>
        </header>

        <nav>
            <ul class="nav nav-pills mb-5" id="quiz-tabs" role="tablist">
                <!-- タブ項目 -->
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="quiz-tab-multiple" 
                            data-bs-toggle="pill" data-bs-target="#quiz-content-multiple" 
                            type="button" role="tab" aria-controls="quiz-content-multiple" 
                            aria-selected="true">4択クイズ</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="quiz-tab-free" 
                            data-bs-toggle="pill" data-bs-target="#quiz-content-free" 
                            type="button" role="tab" aria-controls="quiz-content-free" 
                            aria-selected="false">自由記述</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="quiz-tab-audio" 
                            data-bs-toggle="pill" data-bs-target="#quiz-content-audio" 
                            type="button" role="tab" aria-controls="quiz-content-audio" 
                            aria-selected="false">音階当て</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="quiz-tab-sheet" 
                            data-bs-toggle="pill" data-bs-target="#quiz-content-sheet" 
                            type="button" role="tab" aria-controls="quiz-content-sheet" 
                            aria-selected="false">楽譜クイズ</button>
                </li>
            </ul>
        </nav>

        <main style="max-width: 90%; margin: 0 auto;">
            <div class="tab-content" id="quiz-contents">
                <!-- 4択クイズ -->
                <div class="tab-pane fade show active" id="quiz-content-multiple" role="tabpanel" aria-labelledby="quiz-tab-multiple">
                    <section class="quiz-container" style="max-width: 100%;">
                        <h2 class="h4 mb-4">4択クイズ</h2>
                        <p id="quiz-question-multiple" class="mb-4"></p>
                        <div id="quiz-choices-multiple" class="mb-4"></div>
                        <button class="btn btn-primary" id="quiz-submit-multiple">回答する</button>
                    </section>
                </div>
                
                <!-- 他のクイズセクション (自由記述、音階当て、楽譜) -->
                <div class="tab-pane fade" id="quiz-content-free" role="tabpanel" aria-labelledby="quiz-tab-free">
                    <section class="quiz-container" style="max-width: 100%;">
                        <h2 class="h4 mb-4">自由記述クイズ</h2>
                        <p id="quiz-question-free" class="mb-4"></p>
                        <input type="text" class="form-control mb-2 w-50" id="quiz-answer-free" placeholder="回答を入力してください">
                        <button class="btn btn-primary" id="quiz-submit-free">回答する</button>
                    </section>
                </div>
                
                <div class="tab-pane fade" id="quiz-content-audio" role="tabpanel" aria-labelledby="quiz-tab-audio">
                    <section class="quiz-container" style="max-width: 100%;">
                        <h2 class="h4 mb-4">音階当てクイズ</h2>
                        <button class="btn btn-secondary mb-4" id="quiz-play-audio">
                            <i class="bi bi-play-fill me-2"></i>音を再生
                        </button>
                        <input type="text" class="form-control mb-4 w-50" id="quiz-answer-audio" placeholder="音階を入力してください">
                        <button class="btn btn-primary" id="quiz-submit-audio">回答する</button>
                    </section>
                </div>
                
                <div class="tab-pane fade" id="quiz-content-sheet" role="tabpanel" aria-labelledby="quiz-tab-sheet">
                    <section class="quiz-container">
                        <h2 class="h4 mb-4">楽譜クイズ</h2>
                        <img id="quiz-image-sheet" class="img-fluid mb-4" src="" alt="楽譜">
                        <input type="text" class="form-control mb-4 w-50" id="quiz-answer-sheet" placeholder="楽譜を読み取って入力してください">
                        <button class="btn btn-primary" id="quiz-submit-sheet">回答する</button>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let quizData = null;
        let selectedChoice = null;

        // 初期化処理
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initQuiz();
                setupEventListeners();
            } catch (error) {
                console.error('初期化に失敗:', error);
            }
        });

        // クイズデータの取得
        async function initQuiz() {
            const response = await fetch('quiz-data.json');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            quizData = await response.json();
            displayAllQuizzes();
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            // 各クイズタイプの送信ボタンに対する処理
            document.querySelectorAll('[id^="quiz-submit"]').forEach(button => {
                button.addEventListener('click', () => submitAnswer(button.id.replace('quiz-submit-', '')));
            });
            
            // 音声再生ボタンの処理
            //document.getElementById('quiz-play-audio').addEventListener('click', playAudio);
        }

        // 全てのクイズを表示
        function displayAllQuizzes() {
            ['multiple', 'free', 'audio', 'sheet'].forEach(displayQuiz);
        }

        // 各クイズの表示処理
        function displayQuiz(type) {
            if (!quizData?.[type]) return;

            const quizzes = quizData[type];
            const container = document.getElementById(`quiz-content-${type}`);
            if (!container) return;

            container.innerHTML = ''; // 既存のクイズをクリア

            const section = document.createElement('section');
            section.className = 'quiz-container mb-4';
            section.style.maxWidth = '100%';
            quizzes.forEach((quiz, index) => {

            const questionElement = document.createElement('p');
            questionElement.id = `quiz-question-${type}-${index}`;
            questionElement.className = 'mb-4';
            questionElement.textContent = quiz.question;
            section.appendChild(questionElement);

            if (type === 'multiple') {
                // 4択クイズの選択肢を表示
                const choicesDiv = document.createElement('div');
                choicesDiv.id = `quiz-choices-${type}-${index}`;
                choicesDiv.className = 'mb-4';
                quiz.choices.forEach(choice => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline-primary btn-sm me-2';
                button.textContent = choice;
                // 選択肢がクリックされたときの処理を追加
                button.addEventListener('click', () => handleChoiceSelection(button, choice));
                choicesDiv.appendChild(button);
                });
                section.appendChild(choicesDiv);
            } else if (type === 'audio') {
                // 音声クイズの再生ボタンを表示
                const playButton = document.createElement('button');
                playButton.className = 'quiz-play-audio btn btn-secondary mb-4';
                playButton.innerHTML = '<i class="bi bi-play-fill me-2"></i>音を再生';
                playButton.dataset.audioFile = quiz.audioFile;
                // 再生ボタンがクリックされたときの処理を追加
                playButton.addEventListener('click', playAudio);
                section.appendChild(playButton);
            } else if (type === 'free') {
                const answerInput = document.createElement('input');
                answerInput.type = 'text';
                answerInput.className = 'form-control mb-4 w-50';
                answerInput.id = `quiz-answer-${type}-${index}`;
                answerInput.placeholder = '音階を入力してください';
                section.appendChild(answerInput);
            } else if (type === 'sheet') {
                const image = document.createElement('img');
                image.id = `quiz-image-${type}-${index}`;
                image.className = 'img-fluid mb-4';
                image.src = quiz.imageFile;
                image.alt = '楽譜';
                section.appendChild(image);

                const answerInput = document.createElement('input');
                answerInput.type = 'text';
                answerInput.className = 'form-control mb-4 w-50';
                answerInput.id = `quiz-answer-${type}-${index}`;
                answerInput.placeholder = '楽譜を読み取って入力してください';
                section.appendChild(answerInput);
            } else {
                const answerInput = document.createElement('input');
                answerInput.type = 'text';
                answerInput.className = 'form-control mb-2 w-50';
                answerInput.id = `quiz-answer-${type}-${index}`;
                answerInput.placeholder = '回答を入力してください';
                section.appendChild(answerInput);
            }

            });

            const submitButton = document.createElement('button');
            submitButton.className = 'btn btn-primary';
            submitButton.id = `quiz-submit-${type}`;
            submitButton.textContent = '回答する';
            submitButton.addEventListener('click', () => submitAnswer(type));
            section.appendChild(submitButton);

            container.appendChild(section);
        }

        // 選択肢が選ばれた際の処理
        function handleChoiceSelection(button, choice) {
            const index = button.parentElement.id.split('-').pop();
            document.querySelectorAll(`#quiz-choices-multiple-${index} button`).forEach(btn => {
            btn.classList.remove('active');
            btn.classList.add('btn-outline-primary');
            btn.classList.remove('btn-primary');
            });
            button.classList.add('active');
            button.classList.remove('btn-outline-primary');
            button.classList.add('btn-primary');
            selectedChoice = choice;
        }

        // 回答を提出
        function submitAnswer(type) {
            const quizElements = document.querySelectorAll(`[id^="quiz-question-${type}-"]`);
            let correctCount = 0;
            let totalCount = quizElements.length;

            quizElements.forEach((quizElement, index) => {
                const quiz = quizData[type][index];
                let isCorrect = false;
                let userAnswer;

                if (type === 'multiple') {
                    isCorrect = selectedChoice === quiz.answer;
                } else {
                    // 自由記述、音階、楽譜の場合
                    const answerElement = document.getElementById(`quiz-answer-${type}-${index}`);
                    if (answerElement) {
                        userAnswer = answerElement.value.trim();
                        isCorrect = userAnswer === quiz.answer;
                    }
                }

                if (isCorrect) {
                    correctCount++;
                }
            });

            // 結果を表示
            alert(`正解数: ${correctCount} / ${totalCount}`);
        }

    // 音声を再生する関数
    function playAudio(event) {
        const audioFile = event.target.dataset.audioFile;
        if (audioFile) {
            const audio = new Audio(audioFile);
            audio.play();
        } else {
            console.error('Audio file not found.');
        }
    }
    </script>
</body>
</html>
